<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.ac.kopo.hanafamily.savings.mapper.SavingsInvitationMapper">

  <!-- Result Map for SavingsInvitationDTO -->
  <resultMap id="SavingsInvitationResultMap" type="kr.ac.kopo.hanafamily.savings.dto.SavingsInvitationDTO">
    <id property="invitationId" column="INVITATION_ID" />
    <result property="savingAccountNo" column="SAVING_ACCOUNT_NO" />
    <result property="inviterUserId" column="INVITER_USER_NO" />
    <result property="inviteeUserId" column="INVITEE_USER_NO" />
    <result property="invitationDate" column="INVITATION_DATE" />
    <result property="status" column="STATUS" />
  </resultMap>

  <!-- Insert Invitation -->
  <insert id="insertInvitation" parameterType="kr.ac.kopo.hanafamily.savings.dto.SavingsInvitationDTO">
    INSERT INTO TB_SAVINGS_INVITATION (
      INVITATION_ID,
      SAVING_ACCOUNT_NO,
      INVITER_USER_NO,
      INVITEE_USER_NO,
      INVITATION_DATE,
      STATUS
    ) VALUES (
               SAVINGS_INVITATION_SEQ.NEXTVAL,
               #{savingAccountNo},
               #{inviterUserId},
               #{inviteeUserId},
               #{invitationDate},
               #{status}
             )
  </insert>

  <!-- Select Invitation by ID -->
  <select id="selectInvitationById" parameterType="int" resultMap="SavingsInvitationResultMap">
    SELECT
      INVITATION_ID,
      SAVING_ACCOUNT_NO,
      INVITER_USER_NO,
      INVITEE_USER_NO,
      INVITATION_DATE,
      STATUS
    FROM
      TB_SAVINGS_INVITATION
    WHERE
      INVITATION_ID = #{invitationId}
  </select>
  <!-- Select Pending Invitations by Invitee User ID -->
  <select id="selectPendingInvitationsByInviteeUserId" parameterType="int" resultMap="SavingsInvitationResultMap">
    SELECT
      INVITATION_ID,
      SAVING_ACCOUNT_NO,
      INVITER_USER_NO,
      INVITEE_USER_NO,
      INVITATION_DATE,
      STATUS
    FROM
      TB_SAVINGS_INVITATION
    WHERE
      INVITEE_USER_NO = #{inviteeUserId} AND STATUS = 'PENDING'
  </select>

  <!-- Update Invitation Status -->
  <update id="updateInvitationStatus" parameterType="map">
    UPDATE
      TB_SAVINGS_INVITATION
    SET
      STATUS = #{status}
    WHERE
      INVITATION_ID = #{invitationId}
  </update>
  <resultMap id="SavingProductResultMap" type="kr.ac.kopo.hanafamily.savings.dto.SavingProductDTO">
    <id property="savingAccountNo" column="SAVING_ACCOUNT_NO" />
    <result property="userNo" column="USER_NO" />
    <result property="goalAmount" column="GOAL_AMOUNT" />
    <result property="currentAmount" column="CURRENT_AMOUNT" />
    <result property="startDate" column="START_DATE" />
    <result property="endDate" column="END_DATE" />
    <result property="interestRate" column="INTEREST_RATE" />
    <result property="bonusInterestRate" column="BONUS_INTEREST_RATE" />
    <result property="minDuration" column="MIN_DURATION" />
    <result property="maxDuration" column="MAX_DURATION" />
    <result property="savingStatus" column="SAVING_STATUS" />
    <result property="productId" column="PRODUCT_ID" />
    <result property="representativeAccountNo" column="REPRESENTATIVE_ACCOUNT_NO" />
    <result property="familyId" column="FAMILY_ID" />
    <result property="accountPassword" column="ACCOUNT_PASSWORD" />
    <result property="accountName" column="ACCOUNT_NAME" />
    <result property="bankCode" column="BANK_CODE" />
    <!-- representativeAccountNo은 데이터베이스 컬럼에 없으므로 매핑하지 않음 -->
  </resultMap>
  <select id="selectFamilySavingsList" resultMap="SavingProductResultMap">
    SELECT
      T.SAVING_ACCOUNT_NO,
      T.USER_NO,
      T.GOAL_AMOUNT,
      T.CURRENT_AMOUNT,
      T.START_DATE,
      T.END_DATE,
      T.INTEREST_RATE,
      T.BONUS_INTEREST_RATE,
      T.MIN_DURATION,
      T.MAX_DURATION,
      T.SAVING_STATUS,
      T.PRODUCT_ID,
      T.REPRESENTATIVE_ACCOUNT_NO,
      T.FAMILY_ID,
      T.ACCOUNT_PASSWORD,
      T.ACCOUNT_NAME,
      T.BANK_CODE
    FROM
      TB_SAVING_PRODUCT T
      JOIN
      TB_USERS U ON T.FAMILY_ID = U.FAMILY_ID
    WHERE
      U.USER_NO = #{userNo}  <!-- 파라미터로 전달받은 userNo 사용 -->
      AND T.SAVING_STATUS = 'TERMINATED'
  </select>

</mapper>
